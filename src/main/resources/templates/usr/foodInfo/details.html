<html layout:decorate="~{common/layout/defaultLayout.html}" xmlns:layout="">
<head>
    <title>음식 영양정보</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- 라이브러리 CSS 불러오기 -->
    <link rel="stylesheet" href="/resource/library/library.css">

    <meta th:if="${error}" name="errorMsg" th:content="${exception}"/>

    <meta th:if="${@rq.isLogin()}" name="currentUsername" th:content="${@rq.getMember().getUsername()}"/>
    <meta th:if="${@rq.isLogout()}" name="currentUsername" th:content="no"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #nutrientChart {
            width: 350px;
            height: 350px;
        }
    </style>
</head>

<body>
<main layout:fragment="Content">
    <div class="flex flex-col w-screen h-auto">
        <div class="flex flex-col">
            <div class="m-5 flex justify-around">
                <div class="text-center font-bold text-black text-lg"
                     th:text="${foodInfo.foodName}"></div>
                <a class="btn text-xs"
                   th:onclick="addCart(/*[[${foodInfo.id}]]*/)">
                    장바구니 등록
                </a>
                <a class="btn text-xs"
                   th:href="@{/cartFoodInfo/list}">
                    장바구니 항목
                </a>
            </div>

            <div class="m-3 flex">
                <div class="divider"></div>
                <div class="flex flex-col">
                    <!-- FoodInfo 정보 출력 시작-->
                    <div class="flex">
                        <div class="flex m-1">
                            <div class="text-xs font-bold m-1">제조사/유통사</div>
                            <div class="text-xs text-black m-1" th:text="${foodInfo.manufacturer}"></div>
                        </div>
                        <div class="flex m-1">
                            <div class="text-xs font-bold m-1">식품 대분류</div>
                            <div class="text-xs text-black m-1" th:text="${foodInfo.category}"></div>
                        </div>
                    </div>
                    <div class="flex">
                        <div class="flex m-2">
                            <div class="text-xs font-bold m-1">1회 제공량</div>
                            <div class="text-xs text-black m-1"
                                 th:text="${foodInfo.portionSize} + '(' + ${foodInfo.unit} + ')'"></div>
                        </div>
                        <div class="flex m-2">
                            <div class="text-xs font-bold m-1">총 내용량</div>
                            <div class="text-xs text-black m-1"
                                 th:text="${foodInfo.totalSize} + '(' + ${foodInfo.unit} + ')'"></div>
                        </div>
                    </div>
                    <!-- FoodInfo 정보 출력 끝-->
                    <div class="divider my-2"></div>

                    <canvas id="nutrientChart"></canvas>

                    <div class="divider my-2" style="height: 1px"></div>
                    <!-- nutrientInfo 정보 출력 시작-->
                    <div th:if="${nutrient.value != 0}" th:each="nutrient, loop: ${nutrients}"
                         class="flex justify-between">
                        <div class="flex">
                            <i class="fa-solid fa-list"></i>
                            <div class="text-xs font-bold m-1"
                                 th:text="${nutrient.name} + '(' + ${nutrient.unit} + ')'"></div>
                        </div>
                        <div class="text-xs text-black m-1"
                             th:text="${nutrient.value}"></div>
                        <div class="divider"></div>
                    </div>

                    <!-- nutrientInfo 정보 출력 끝-->
                </div>
                <div class="divider my-2" style="height: 1px"></div>
            </div>

        </div>
    </div>
    <script th:inline="javascript">
        const background = [
            "#FF6384",
            "#36A2EB",
            "#FFCE56",
            "#4BC0C0",
            "#FF8C00",
            "#9966FF",
            "#C0C0C0",
            "#FFD700",
            "#3CB371",
            "#FF4500",
            "#00BFFF",
            "#BA55D3",
            "#008080",
            "#F08080"
        ];

        let hoverBackground = [
            "#FF6384",
            "#36A2EB",
            "#FFCE56",
            "#4BC0C0",
            "#FF8C00",
            "#9966FF",
            "#C0C0C0",
            "#FFD700",
            "#3CB371",
            "#FF4500",
            "#00BFFF",
            "#BA55D3",
            "#008080",
            "#F08080"
        ];


        var nutrientData = {
            labels: [],
            datasets: [
                {
                data: [],
                backgroundColor: [],
                hoverBackgroundColor: []
            }]
        };

        let label;
        let value;
        let back;
        let hover;
        let loopIndex;

        // 원형 그래프를 그릴 데이터
        /*[# th:each="nutrient, loop : ${nutrients}"]*/
            loopIndex = /*[[${loop.index}]]*/null;
            label = /*[[${nutrient.name}]]*/null;
            value = /*[[${nutrient.value}]]*/null;
            back = background[loopIndex];
            hover = hoverBackground[loopIndex];

            if (value != 0) {
                nutrientData.labels.push(label);
                nutrientData.datasets[0].data.push(value);
                nutrientData.datasets[0].backgroundColor.push(back);
                nutrientData.datasets[0].hoverBackgroundColor.push(hover);
            }
        /*[/]*/

        // 원형 그래프의 옵션
        const options = {
            responsive: false,
            maintainAspectRatio: false
        };

        // 캔버스 요소 선택
        const ctx = document.getElementById("nutrientChart").getContext("2d");

        // 원형 그래프 생성
        new Chart(ctx, {
            type: "doughnut",
            data: nutrientData,
            options: options
        });

        function addCart(foodId) {
            const header = $("meta[name='_csrf_header']").attr("content");
            const token = $("meta[name='_csrf']").attr("content");
            $(document).ajaxSend(function (e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });
            if (foodId) {
                $.ajax({
                    type: "POST",
                    url: "/cartFoodInfo/add", // 좋아요 요청을 보낼 URL
                    data: {
                        foodId: foodId
                    },
                    dataType: "json",
                    success: function (response) {
                        if (response.result === "success") { // 좋아요 데이터가 없음 -> 좋아요 표시
                            console.log("success");
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }
        }

    </script>
</main>
</body>

</html>